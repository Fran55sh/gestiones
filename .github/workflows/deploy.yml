name: CI/CD Pipeline - Oracle Cloud Infrastructure

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:  # Permite ejecutar manualmente desde GitHub Actions

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Job de Tests
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests with pytest
        run: |
          pytest -v --tb=short --cov=app --cov-report=term-missing

      - name: Upload coverage reports
        if: always()
        uses: codecov/codecov-action@v4
        with:
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  # Job de Deploy a Staging (desde branch develop)
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: staging
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY_DEV }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SSH_HOST_DEV }} >> ~/.ssh/known_hosts

      - name: Verify SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST_DEV }} "echo 'SSH connection successful'"

      - name: Deploy to staging server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST_DEV }} << 'ENDSSH'
            set -e
            echo "üöÄ Iniciando despliegue a staging..."
            
            # Navegar al directorio del proyecto
            cd ~/gestiones-mvp || { echo "‚ùå Directorio del proyecto no encontrado"; exit 1; }
            
            # Guardar cambios locales si existen
            git stash || true
            
            # Obtener cambios del repositorio
            echo "üì• Obteniendo cambios del repositorio..."
            git fetch origin develop
            git reset --hard origin/develop
            git clean -fd
            
            # Verificar que existe .env.prod
            if [ ! -f ".env.prod" ]; then
              echo "‚ö†Ô∏è  ADVERTENCIA: .env.prod no encontrado"
              echo "El despliegue continuar√°, pero aseg√∫rate de configurar las variables de entorno"
            fi
            
            # Ejecutar script de despliegue
            echo "üî® Ejecutando script de despliegue..."
            chmod +x deploy.sh
            ./deploy.sh
            
            echo "‚úÖ Despliegue a staging completado"
          ENDSSH

      - name: Verify deployment
        run: |
          echo "üîç Verificando healthcheck..."
          sleep 5
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST_DEV }} << 'ENDSSH'
            # Verificar que el contenedor est√° corriendo
            if docker compose -f docker-compose.prod.yml --project-name gestiones-prod ps | grep -q "Up"; then
              echo "‚úÖ Contenedor est√° corriendo"
            else
              echo "‚ùå Error: Contenedor no est√° corriendo"
              docker compose -f docker-compose.prod.yml --project-name gestiones-prod ps
              exit 1
            fi
            
            # Verificar healthcheck
            if curl -f http://localhost:5000/healthz > /dev/null 2>&1; then
              echo "‚úÖ Healthcheck OK"
            else
              echo "‚ö†Ô∏è  Healthcheck no responde a√∫n"
            fi
          ENDSSH

      - name: Show deployment logs
        if: always()
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST_DEV }} << 'ENDSSH'
            echo "üìã √öltimos logs del contenedor:"
            docker compose -f docker-compose.prod.yml --project-name gestiones-prod logs --tail=50
          ENDSSH

  # Job de Deploy a Producci√≥n (desde branch main)
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY_PROD }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SSH_HOST_PROD }} >> ~/.ssh/known_hosts

      - name: Verify SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST_PROD }} "echo 'SSH connection successful'"

      - name: Deploy to production server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST_PROD }} << 'ENDSSH'
            set -e
            echo "üöÄ Iniciando despliegue a PRODUCCI√ìN..."
            echo "‚ö†Ô∏è  ATENCI√ìN: Este es un despliegue a producci√≥n"
            
            # Navegar al directorio del proyecto
            cd ~/gestiones-mvp || { echo "‚ùå Directorio del proyecto no encontrado"; exit 1; }
            
            # Guardar cambios locales si existen
            git stash || true
            
            # Obtener cambios del repositorio
            echo "üì• Obteniendo cambios del repositorio..."
            git fetch origin main
            git reset --hard origin/main
            git clean -fd
            
            # Verificar que existe .env.prod
            if [ ! -f ".env.prod" ]; then
              echo "‚ùå ERROR: .env.prod no encontrado en producci√≥n"
              echo "El despliegue no puede continuar sin el archivo de configuraci√≥n"
              exit 1
            fi
            
            # Verificar SECRET_KEY antes de desplegar
            if grep -q "GENERAR_UNA_CLAVE_SECRETA_FUERTE_AQUI" .env.prod || grep -q "dev-secret-key-cambia-esto" .env.prod; then
              echo "‚ùå ERROR: SECRET_KEY no est√° configurado correctamente en producci√≥n"
              exit 1
            fi
            
            # Crear backup del estado actual (opcional)
            echo "üíæ Creando backup del estado actual..."
            docker compose -f docker-compose.prod.yml --project-name gestiones-prod ps > /tmp/gestiones-backup-status.txt || true
            
            # Ejecutar script de despliegue
            echo "üî® Ejecutando script de despliegue..."
            chmod +x deploy.sh
            ./deploy.sh
            
            echo "‚úÖ Despliegue a producci√≥n completado"
          ENDSSH

      - name: Verify deployment
        run: |
          echo "üîç Verificando healthcheck en producci√≥n..."
          sleep 10
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST_PROD }} << 'ENDSSH'
            # Verificar que el contenedor est√° corriendo
            if docker compose -f docker-compose.prod.yml --project-name gestiones-prod ps | grep -q "Up"; then
              echo "‚úÖ Contenedor est√° corriendo"
            else
              echo "‚ùå Error: Contenedor no est√° corriendo"
              docker compose -f docker-compose.prod.yml --project-name gestiones-prod ps
              exit 1
            fi
            
            # Verificar healthcheck
            if curl -f http://localhost:5000/healthz > /dev/null 2>&1; then
              echo "‚úÖ Healthcheck OK"
            else
              echo "‚ùå ERROR: Healthcheck fall√≥ en producci√≥n"
              exit 1
            fi
          ENDSSH

      - name: Show deployment logs
        if: always()
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST_PROD }} << 'ENDSSH'
            echo "üìã √öltimos logs del contenedor:"
            docker compose -f docker-compose.prod.yml --project-name gestiones-prod logs --tail=50
          ENDSSH

      - name: Rollback on failure
        if: failure()
        run: |
          echo "‚ö†Ô∏è  El despliegue fall√≥. Considera hacer rollback manualmente"
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST_PROD }} << 'ENDSSH'
            echo "Ver estado actual:"
            docker compose -f docker-compose.prod.yml --project-name gestiones-prod ps
            echo ""
            echo "Para hacer rollback, ejecuta en el servidor:"
            echo "  cd ~/gestiones-mvp"
            echo "  git reset --hard HEAD~1"
            echo "  ./deploy.sh"
          ENDSSH
